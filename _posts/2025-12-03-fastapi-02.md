---
layout: single
title: "[FastAPI] FastAPI 종료시 비동기 SQLAlchemy 엔진 종료"
categories: Fastapi
tags: [fastapi, database]
toc: true
---

### fastAPI 종료시에 엔진을 종료해야 하는 이유
- fastapi가 종료되어도 db 서버에서는 감지 못할 수도 있음
  - 서버가 갑작스럽게 꺼진다면 tcp 연결 종료 메세지를 보내지 못할 수도 있음
  - 이는 db 커넥션 타임아웃이 만료되어야 종료됨
  - 서버가 다시 온 되어도 메모리는 초기화 되기 때문에 좀비로 놓아져 있던 커넥션 풀을 다시 잡을 수 없음
- 트랜잭션 안전장치 기능
  - 트랜잭션 처리 중 서버가 갑자기 종료되면 해당 풀이 잠김
  - 따라서 데이터가 잠긴 상태로 두면 문제 발생 가능(이후 서버 부팅 후 같은 데이터 요청 등)
  - 서버가 종료되면 engine.dispose()으로 롤백

### 구현
```python
@asynccontextmanager
async def lifespan(app: FastAPI):
    print("Starting up...")
    yield
    print("shutting down...")
    await engine.dispose()

app = FastAPI(lifespan=lifespan)
```

### lifespan은 정말 안전할까? 

- 정말 전원이 갑작스럽게 차단된 상황이라면 lifespan조차 실행 안될 수도 있음
- 그렇게 된다면 위와 같은 문제 발생
  
| lifespan은 아주 최소일뿐 인프라 레벨에서 안전장치로 대비해야한다고 생각. 아직 정확한 구현 방안은 모르나 로그 처리 혹은 연결된 외부 api 데이터와 실제 데이터 일치 비교 후 처리
