---
layout: single
title: "[LangGraph] 멀티 에이전트 구현(간단한 라우팅 테스트)"
categories: LangGraph
tags: [LangGraph]
toc: true
---

## 멀티 에이전트 구현

#### 현재 에이전트

- 웹 크롤링 기반으로 데이터로 임베딩한 벡터 스토어에서 리트리버 후 답변 생성하는 에이전트
- 관련 없는 질문이 들어왔을 때 처리하는 에이전트 (아직은 사실상 단일 노드)

동작 : start에서 질문에 대한 에이전트 라우팅 후 end

```python
from  dotenv import load_dotenv

load_dotenv()

from langchain_classic import hub
from langchain_openai import ChatOpenAI
prompt = hub.pull("rlm/rag-prompt")
llm = ChatOpenAI(model='gpt-5-mini')

from typing_extensions import List, TypedDict
from langchain_core.documents import Document
from langgraph.graph import StateGraph

class AgentState(TypedDict):
    query:str
    context: list
    answer: str
    
graph_builder = StateGraph(AgentState)

from langchain_core.prompts import ChatPromptTemplate
from pydantic import BaseModel, Field
from typing import Literal

class Route(BaseModel):
    target: Literal['sku_web', 'llm'] = Field(
        description="the target for the query to answer"
    )

router_system_prompt = """Classify the query target based on the context.
- sku-web: Seokyeong Univ specific info (cafeteria, schedule, bus, graduation, notices). Choose this for school-related context even without explicit keywords.
- llm: General chat, greetings, coding questions, or common knowledge."""

router_prompt = ChatPromptTemplate.from_messages([
    ('system', router_system_prompt),
    ('user', '{query}')
])

structured_router_llm = llm.with_structured_output(Route)

def router(state: AgentState) -> Literal['sku_web', 'llm']:
    query = state['query']
    router_chain = router_prompt | structured_router_llm
    route = router_chain.invoke({'query': query})

    return route.target

from langchain_core.output_parsers import StrOutputParser

def call_llm(state: AgentState) -> AgentState:
    query = state['query']
    llm_chain = llm | StrOutputParser()
    llm_answer = llm_chain.invoke(query)
    return {'answer': llm_answer}

from sku_web_graph import graph as sku_web_agent

graph_builder.add_node('sku_web', sku_web_agent)
graph_builder.add_node('llm', call_llm)

from langgraph.graph import START, END

graph_builder.add_conditional_edges(
    START,
    router,
    {
        'sku_web': 'sku_web',
        'llm': 'llm'
    }
)

graph_builder.add_edge('sku_web', END)
graph_builder.add_edge('llm', END)

graph = graph_builder.compile()

initial_state = {'query': '정릉 근처 맛집 알려줘'}
graph.invoke(initial_state)
```

```markdown
{'query': '정릉 근처 맛집 알려줘',
 'answer': '원하시는 스타일을 알려주시면 더 정확히 추천드릴게요 — 한식(백반/찌개), 고기(구이/갈비), 중식, 일식(초밥/라멘), 분식/길거리, 가성비/데이트/혼밥 등 어떤 걸 좋아하세요? 예산(1인당 얼마 정도)이나 인원(혼자/여럿)도 알려주시면 좋아요.\n\n일단 선호를 몰라서 범주별로 간단히 안내드립니다:\n\n- 정릉시장(정릉전통시장) — 지역 맛집과 분식, 좌판 음식(순대, 튀김, 떡볶이 등)을 골고루 즐길 수 있어요. 가성비 좋습니다.\n- 한식/백반류 — 정릉 일대에 된장찌개, 제육, 갈치조림 등 가정식 백반집이 많습니다. 점심 한 끼 편하게 먹기 좋아요.\n- 삼계탕/보양식 — 여름철 보양집이 몇 군데 있고, 전통 삼계탕을 파는 곳을 찾기 쉽습니다.\n- 고기/구이류 — 근처에 소고기·돼지고기 구이집이 포진해 있어 회식이나 가족 외식에 적합합니다.\n- 카페/디저트 — 정릉천 주변과 솔밭길 쪽에 분위기 좋은 카페들이 있어 산책 후 들르기 좋아요.\n\n원하시면\n1) 원하시는 음식 종류 및 예산/인원 알려주시면 구체적 가게 몇 곳(메뉴, 분위기, 추천 메뉴 포함) 추천해드리고,\n2) 또는 지금 당장 위치 기반으로 최신 리뷰/영업시간 확인하는 법(네이버 지도/카카오맵 검색 키워드와 팁)도 알려드릴게요. 어느 쪽으로 도와드릴까요?'}
```

| 그래프로 충분히 나타낼 수 있었으나 추후 몇가지 에이전트를 더 만들거기 때문에 만들어 놓은 에이전트에 대한 라우팅 테스트