---
layout: single
title: "[트레이드오프] Pk설정시 자연키 vs 대리키"
categories: database
tags: [tradeoff, database]
toc: true
---

## 현대에는 PK로 대리키를 많이 사용한다 왜?

데이터베이스 테이블 설계 공부 중에 의문이 들었다.  
왜 대부분의 테이블은 PK로 대리키를 사용할까? 대리키를 사용하면 join으로 결합해야만 데이터를 추출해야하는 일이 벌어진다. 그럼에도 얻는 이점이 무엇일까?  
모든 기술적 선택은 트레이드오프다.    
그럼 어떤 부분때문에 대리키를 PK로 사용할까? 

## PK를 자연키로 설정한 테이블

학생테이블과 수강과목테이블로 간략화 하여 구성했다

- 학생 테이블

| 학번(pk)   | 이름   | 전화번호      |
| ---------- | ------ | ------------- |
| 2021903945 | 홍길동 | 010-1234-5678 |
| 2022493819 | 길동홍 | 010-2341-3423 |
| 2025103929 | 동홍길 | 010-4823-1238 |

- 수강과목 테이블

| 수강과목_id(pk) | 학번(fk)   | 교수님성함 | 과목이름     | 수업시간 |
| --------------- | ---------- | ---------- | ------------ | -------- |
| 1               | 2021903945 | 김교수     | 파이썬       | 3        |
| 2               | 2022493819 | 박교수     | 데이터베이스 | 2        |
| 3               | 2025103929 | 이교수     | 네트워크     | 3        |

만약 여기서 홍길동 학생이 수강한 과목이름을 조회하고 싶으면 그냥 수강과목 테이블만 참조해서 보면 된다.

``` sql
SELECT 과목이름 FROM 수강과목테이블 WHERE 학번 = 2021903945
```

Join에 사용되는 비용없이 바로 조회가 가능하고 쿼리도 직관적이다.  
실제로 과거에는 자연키를 pk로 많이 사용하기도 했다고 들었다.  
하지만 조금만 더 생각해보면 단순성과 직관성을 얻은 대신 비용적인 손해가 크다.   
다음과 같은 예시를 생각해볼 수 있다  

- 학교내 정책변경으로 학번이 변경되는 경우 

학번을 변경하기 위해 두 테이블 모두의 학번을 변경해야한다. 특히나 현대의 데이터양은 과거보다 빠르게 늘어나고 관계형 데이터베이스이다 보니 더 깊은 관계로 구성되어 있다. 심지어 만약에 서비스가 커지면서 테이블 수가 더 많아지고 그 테이블의 변경하기 위한 비용이 훨씬 커질 것이다.

- 데이터 추가시 인덱스 업데이트 비용 손해 

pk는 인덱스로 저장되기 때문에 자연키를 인덱스로 저장하면 데이터 생성시 불규칙 값이 올 확률이 높다. 따라서 데이터가 생성될 때 인덱스를 업데이트 하는 과정에서 비용이 발생한다. 학번 같은 경우에는 순차적일 확률이 있겠지만 만약 이메일 주소같은 자연키가 인덱스가 된다면 B-Tree 구조일지라도 대리키는 무조건적인 순차적인 증가이므로 가장 뒤에 업데이트 하면 되는 반면에 자연키는 logN의 시간복잡도를 가지고 추적하여 업데이트를 해야한다.

## PK를 대리키로 설정한 테이블

학생테이블과 수강과목테이블로 간략화 하여 구성했다

- 학생 테이블

| 학생_id(pk) | 학번       | 학생이름 | 전화번호      |
| ----------- | ---------- | -------- | ------------- |
| 1           | 2021903945 | 홍길동   | 010-1234-5678 |
| 2           | 2022493819 | 길동홍   | 010-2341-3423 |
| 3           | 2025103929 | 동홍길   | 010-4823-1238 |

- 수강과목 테이블

| 수강과목_id(pk) | 학생_id(fk) | 교수님성함 | 과목이름     | 수업시간 |
| --------------- | ----------- | ---------- | ------------ | -------- |
| 1               | 1           | 김교수     | 파이썬       | 3        |
| 2               | 2           | 박교수     | 데이터베이스 | 2        |
| 3               | 3           | 이교수     | 네트워크     | 3        |

만약 여기서 홍길동 학생이 수강한 과목 이름을 조회하고 싶다면 Join을 사용해야한다.  
```sql
SELECT c.과목이름
FROM 수강과목테이블 AS c
JOIN 학생테이블 AS p ON c.학생_id = p.학생_id
WHERE p.학생이름 = '홍길동'
```

PK를 자연키로 설정할때보다 컬럼이 더 늘어났고 쿼리도 복잡해졌다.   
하지만 자연키의 단점이였던 부분을 생각해보자  

- 학교내 정책변경으로 학번이 변경되는 경우

단순하다. 그냥 학생 테이블만 변경하면 된다.  
데이터 추가시 인덱스 업데이트도 비용이 더 작다.  

## 결론..

내가 데이터베이스를 설계한다면 대리키를 PK로 사용할 것이다.    
테이블이 작다면 직관적인 자연키를 더 선호할 수 있겠지만 (지금 지식으로는 현대에서는 그럴 가능성이 없을거라고 생각한다.) 현대에서는 데이터가 빠르게 늘어나고 서비스도 복잡하게 엮여있다고 생각한다. 확장성이 빨라진 지금은 대리키를 PK로 사용하여 안전하게 유지보수 하는게 더 나은 방법이라고 생각한다. 